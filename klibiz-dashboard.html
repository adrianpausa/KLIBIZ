<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KLIBIZ - Vollversion mit allen Features</title>
<style>
* {box-sizing: border-box; margin: 0; padding: 0;}
body {font-family: 'Segoe UI', sans-serif; background: #f6f8fb; height: 100vh; display: flex; flex-direction: column;}
header {background: linear-gradient(135deg, #e20074 0%, #c1005f 100%); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;}
header h1 {font-size: 1.5em;}
.subtitle {font-size: 0.75em; opacity: 0.9; margin-top: 3px;}
.container {display: flex; flex: 1; overflow: hidden;}
.sidebar {width: 340px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;}
.sidebar-header {padding: 20px; border-bottom: 1px solid #e0e0e0;}
.filter-tabs {display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap;}
.filter-tab {padding: 6px 12px; border-radius: 20px; background: #f0f0f0; border: none; cursor: pointer; font-size: 0.85em;}
.filter-tab.active {background: #e20074; color: white;}
.search-box {width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;}
.patient-list {flex: 1; overflow-y: auto; padding: 10px;}
.patient-card {background: white; padding: 14px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; border: 2px solid #e0e0e0; position: relative;}
.patient-card:hover {border-color: #e20074;}
.patient-card.active {border-color: #e20074; background: #fff5fb;}
.patient-card.archived {opacity: 0.6;}
.risk-indicator {position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite;}
.risk-high {background: #f44336;}
.risk-medium {background: #ff9800;}
.risk-low {background: #4caf50;}
@keyframes pulse {0%, 100% {opacity: 1;} 50% {opacity: 0.5;}}
.patient-name {font-weight: 600; color: #333; margin-bottom: 3px;}
.patient-diagnose {font-size: 0.8em; color: #666; font-style: italic; margin-bottom: 3px;}
.patient-id {font-size: 0.75em; color: #999;}
.risk-badge {display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 700; margin-top: 8px;}
.risk-badge.high {background: #ffebee; color: #c62828;}
.risk-badge.medium {background: #fff3e0; color: #f57c00;}
.risk-badge.low {background: #e8f5e9; color: #2e7d32;}
.patient-meta {display: flex; gap: 12px; font-size: 0.8em; color: #666; margin-top: 10px; flex-wrap: wrap;}
.main {flex: 1; display: flex; flex-direction: column;}
.main-header {background: white; border-bottom: 1px solid #e0e0e0; padding: 20px 25px;}
.action-buttons {display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
.btn {padding: 8px 16px; border-radius: 8px; border: 1px solid #e0e0e0; background: white; cursor: pointer; font-size: 0.9em;}
.btn:hover {background: #e20074; color: white; border-color: #e20074;}
.btn.primary {background: #e20074; color: white;}
.btn.danger {background: #f44336; color: white;}
.btn.warning {background: #ff9800; color: white;}
.tabs {display: flex; background: white; border-bottom: 1px solid #e0e0e0; padding: 0 25px; overflow-x: auto;}
.tab {padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; color: #666;}
.tab.active {color: #e20074; border-bottom-color: #e20074;}
.content-wrapper {display: flex; flex: 1; overflow: hidden;}
.content-area {flex: 1; display: flex; flex-direction: column;}
.tab-content {display: none; flex: 1; flex-direction: column; overflow: hidden;}
.tab-content.active {display: flex;}
.chat-messages {flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px;}
.message {max-width: 65%; padding: 12px 16px; border-radius: 12px;}
.message.from-patient {background: white; border: 1px solid #e0e0e0; align-self: flex-start;}
.message.from-nurse {background: linear-gradient(135deg, #e20074 0%, #c1005f 100%); color: white; align-self: flex-end;}
.message.system {background: #e3f2fd; border: 1px solid #2196f3; align-self: center; max-width: 80%; text-align: center;}
.message-sender {font-weight: 600; font-size: 0.9em; margin-bottom: 5px;}
.message-text {line-height: 1.5;}
.message-time {font-size: 0.75em; opacity: 0.7; margin-top: 5px;}
.message-image {max-width: 250px; border-radius: 8px; margin-top: 8px; cursor: pointer;}
.chat-input-area {background: white; border-top: 1px solid #e0e0e0; padding: 20px 25px; display: flex; gap: 12px;}
.upload-label {padding: 10px 16px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;}
.input-box {flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 25px;}
.info-panel {width: 320px; background: white; border-left: 1px solid #e0e0e0; padding: 25px; overflow-y: auto;}
.info-section {margin-bottom: 25px;}
.info-section h4 {color: #e20074; margin-bottom: 12px;}
.info-row {margin-bottom: 10px; font-size: 0.9em;}
.panel-container {padding: 25px; overflow-y: auto;}
.modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px;}
.modal.active {display: flex;}
.modal-content {background: white; border-radius: 16px; padding: 30px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;}
.modal-header {display: flex; justify-content: space-between; margin-bottom: 20px;}
.close-btn {background: none; border: none; font-size: 1.5em; cursor: pointer;}
.modal-footer {margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;}
.form-group {margin-bottom: 20px;}
.form-label {display: block; margin-bottom: 8px; font-weight: 600;}
.form-input, .form-select, .form-textarea {width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;}
.form-textarea {min-height: 120px; resize: vertical;}
.alert-box {padding: 15px; border-radius: 8px; margin: 15px 0; display: flex; gap: 12px;}
.alert-box.info {background: #e3f2fd; border-left: 4px solid #2196f3;}
.alert-box.warning {background: #fff3e0; border-left: 4px solid #ff9800;}
.template-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;}
.template-btn {padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; text-align: left;}
.template-btn:hover {border-color: #e20074; background: #fff5fb;}
.vitals-chart {background: white; padding: 20px; margin: 15px 0; border-radius: 12px;}
.chart-bars {display: flex; align-items: flex-end; height: 200px; gap: 10px; background: #f5f5f5; padding: 20px; border-radius: 8px;}
.chart-bar {flex: 1; background: #e20074; border-radius: 4px 4px 0 0; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; position: relative;}
.empty-state {text-align: center; padding: 60px 20px; color: #999;}
</style>
</head>
<body>

<header>
  <div>
    <h1>ğŸ¥ KLIBIZ</h1>
    <div class="subtitle">Klinisches Informations- und Beratungszentrum fuer Pflege</div>
  </div>
  <div style="text-align: right;">
    <div style="font-weight: 600;">M. Muehlbach</div>
    <div style="font-size: 0.75em; opacity: 0.8;">Pflegeexpertin Telepflege</div>
  </div>
</header>

<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Patienten</h3>
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">Alle</button>
        <button class="filter-tab" data-filter="high-risk">Hoch</button>
        <button class="filter-tab" data-filter="medium-risk">Mittel</button>
        <button class="filter-tab" data-filter="low-risk">Niedrig</button>
        <button class="filter-tab" data-filter="archived">Archiv</button>
      </div>
      <input type="text" class="search-box" id="searchBox" placeholder="Patient suchen...">
    </div>
    <div class="patient-list" id="patientList"></div>
  </div>

  <div class="main">
    <div class="main-header">
      <h2 id="patientName">Patient auswaehlen</h2>
      <div id="statusText" style="color: #666; font-size: 0.9em; margin-top: 5px;">Waehlen Sie einen Patienten</div>
      <div class="action-buttons" id="actionButtons" style="display: none;">
        <button class="btn primary" onclick="makePhoneCall()">ğŸ“ Anrufen</button>
        <button class="btn primary" onclick="makeVideoCall()">ğŸ“¹ Video</button>
        <button class="btn" onclick="openQuickReply()">âš¡ Schnellantwort</button>
        <button class="btn" onclick="openPegasos()">ğŸ¥ PEGASOS</button>
        <button class="btn" onclick="openDoctorReferral()">âš•ï¸ An Arzt</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="chat">ğŸ’¬ Beratung</div>
      <div class="tab" data-tab="documentation">ğŸ“‹ Dokumentation</div>
      <div class="tab" data-tab="vitals">ğŸ“ˆ Vitalwerte</div>
      <div class="tab" data-tab="meds">ğŸ’Š Medikation</div>
      <div class="tab" data-tab="wounds">ğŸ©¹ Wunden</div>
      <div class="tab" data-tab="tasks">âœ… Aufgaben</div>
      <div class="tab" data-tab="handover">ğŸ”„ Ãœbergabe</div>
      <div class="tab" data-tab="callbacks">ğŸ“ RÃ¼ckrufe</div>
      <div class="tab" data-tab="team">ğŸ‘¥ Team</div>
      <div class="tab" data-tab="quality">ğŸ“Š QualitÃ¤t</div>
    </div>

    <div class="content-wrapper">
      <div class="content-area">
        <div class="tab-content active" id="chatTab">
          <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
              <div style="font-size: 4em; margin-bottom: 20px;">ğŸ’¬</div>
              <p>Waehlen Sie einen Patienten</p>
            </div>
          </div>
          <div class="chat-input-area" id="chatInputArea" style="display: none;">
            <label for="fileUpload" class="upload-label">ğŸ“ Datei</label>
            <input type="file" id="fileUpload" style="display: none;" accept="image/*">
            <input type="text" class="input-box" id="messageInput" placeholder="Nachricht...">
            <button class="btn primary" onclick="sendMessage()">Senden</button>
          </div>
        </div>

        <div class="tab-content" id="documentationTab">
          <div class="panel-container" id="documentationContainer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>ğŸ“‹ Leistungsdokumentation</h3>
              <div>
                <button class="btn primary" onclick="openAddDocumentation()">+ Leistung erfassen</button>
                <button class="btn" onclick="exportDocumentation()">ğŸ“Š Export (Controlling)</button>
              </div>
            </div>
            
            <div class="alert-box info">
              <span style="font-size: 1.5em;">ğŸ’¡</span>
              <div>Alle Kontakte werden automatisch dokumentiert. Zusaetzliche manuelle Dokumentation bei Bedarf moeglich.</div>
            </div>
            
            <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 12px;">
              <h4>Zeiterfassung - Aktueller Patient</h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <div style="font-size: 2em; font-weight: 700; color: #e20074;" id="docTotalTime">0h 0m</div>
                  <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Gesamt</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <div style="font-size: 2em; font-weight: 700; color: #2196f3;" id="docChats">0</div>
                  <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Chat-Beratungen</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <div style="font-size: 2em; font-weight: 700; color: #2196f3;" id="docCalls">0</div>
                  <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Anrufe</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <div style="font-size: 2em; font-weight: 700; color: #4caf50;" id="docRevenue">0 â‚¬</div>
                  <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Geschaetzter ErloÃ©s</div>
                </div>
              </div>
            </div>
            
            <div id="documentationList"></div>
          </div>
        </div>

        <div class="tab-content" id="vitalsTab">
          <div class="panel-container" id="vitalsContainer"></div>
        </div>

        <div class="tab-content" id="medsTab">
          <div class="panel-container" id="medsContainer"></div>
        </div>

        <div class="tab-content" id="woundsTab">
          <div class="panel-container" id="woundsContainer"></div>
        </div>

        <div class="tab-content" id="tasksTab">
          <div class="panel-container" id="tasksContainer"></div>
        </div>

        <div class="tab-content" id="handoverTab">
          <div class="panel-container" id="handoverContainer"></div>
        </div>

        <div class="tab-content" id="callbacksTab">
          <div class="panel-container" id="callbacksContainer"></div>
        </div>

        <div class="tab-content" id="teamTab">
          <div class="panel-container" id="teamContainer"></div>
        </div>

        <div class="tab-content" id="qualityTab">
          <div class="panel-container" id="qualityContainer"></div>
        </div>
      </div>
          <div class="panel-container" id="vitalsContainer"></div>
        </div>

        <div class="tab-content" id="medsTab">
          <div class="panel-container" id="medsContainer"></div>
        </div>

        <div class="tab-content" id="woundsTab">
          <div class="panel-container" id="woundsContainer"></div>
        </div>

        <div class="tab-content" id="tasksTab">
          <div class="panel-container" id="tasksContainer"></div>
        </div>
      </div>

      <div class="info-panel" id="infoPanel" style="display: none;">
        <div class="info-section">
          <h4>ğŸ“‹ Patienteninfo</h4>
          <div class="info-row"><strong>Fallnummer:</strong> <span id="infoId">-</span></div>
          <div class="info-row"><strong>Diagnose:</strong> <span id="infoDiagnose">-</span></div>
          <div class="info-row"><strong>Entlassung:</strong> <span id="infoEntlass">-</span></div>
          <div class="info-row"><strong>Risiko:</strong> <span id="infoRisk">-</span></div>
        </div>
        <div class="info-section">
          <h4>âš ï¸ Warnungen</h4>
          <div id="earlyWarnings"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Reply Modal -->
<div class="modal" id="quickReplyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âš¡ Schnellantwort</h3>
      <button class="close-btn" onclick="closeModal('quickReplyModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="template-grid">
        <div class="template-btn" onclick="useTemplate('Bitte nehmen Sie Ihre Medikamente wie verordnet ein.')">ğŸ’Š Medikamente</div>
        <div class="template-btn" onclick="useTemplate('Bitte trinken Sie ausreichend Fluessigkeit.')">ğŸ’§ Trinken</div>
        <div class="template-btn" onclick="useTemplate('Wie geht es Ihnen heute?')">â“ Befinden</div>
        <div class="template-btn" onclick="useTemplate('Bitte senden Sie mir ein Foto.')">ğŸ“¸ Foto</div>
      </div>
      <div class="form-group" style="margin-top: 20px;">
        <textarea class="form-textarea" id="quickReplyText"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('quickReplyModal')">Abbrechen</button>
      <button class="btn primary" onclick="sendQuickReply()">Senden</button>
    </div>
  </div>
</div>

<!-- PEGASOS Modal -->
<div class="modal" id="pegasosModal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h3>ğŸ¥ PEGASOS Patientenakte</h3>
      <button class="close-btn" onclick="closeModal('pegasosModal')">&times;</button>
    </div>
    <div class="modal-body" id="pegasosContent"></div>
  </div>
</div>

<!-- Doctor Referral Modal -->
<div class="modal" id="doctorModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âš•ï¸ An Stationsarzt</h3>
      <button class="close-btn" onclick="closeModal('doctorModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Dringlichkeit</label>
        <select class="form-select" id="urgency">
          <option value="routine">Routine (1 Woche)</option>
          <option value="urgent">Dringend (24h)</option>
          <option value="immediate">Sofort</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Fachabteilung</label>
        <select class="form-select" id="department">
          <option>Kardiologie</option>
          <option>Gastroenterologie</option>
          <option>Pneumologie</option>
          <option>Chirurgie</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Grund</label>
        <textarea class="form-textarea" id="doctorReason"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('doctorModal')">Abbrechen</button>
      <button class="btn primary" onclick="submitDoctorReferral()">Senden</button>
    </div>
  </div>
</div>

<!-- Add Documentation Modal -->
<div class="modal" id="addDocModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ Leistung dokumentieren</h3>
      <button class="close-btn" onclick="closeModal('addDocModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="alert-box warning">
        <span style="font-size: 1.5em;">ğŸ’°</span>
        <div><strong>Wichtig:</strong> Diese Dokumentation ist abrechnungsrelevant nach GOAe / SGB V / SGB XI.</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Leistungsart</label>
        <select class="form-select" id="docType" onchange="updateDocTemplate()">
          <option value="">-- Bitte waehlen --</option>
          <option value="telefonberatung">Telefonische Beratung (15-30 Min.)</option>
          <option value="videosprechstunde">Videosprechstunde (20-40 Min.)</option>
          <option value="chatberatung">Chat-basierte Beratung (10-20 Min.)</option>
          <option value="symptomabklaerung">Symptomabklaerung / Triagierung</option>
          <option value="medikationsberatung">Medikationsberatung</option>
          <option value="wundbeurteilung">Wundbeurteilung (Foto-basiert)</option>
          <option value="schulung">Patientenschulung / Anleitung</option>
          <option value="krisenintervention">Krisenintervention</option>
          <option value="eskalation">Eskalation / Weiterleitung</option>
          <option value="angehoerigengespraech">Angehoerigengespraech</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Dauer (Minuten)</label>
        <input type="number" class="form-input" id="docDuration" value="15" min="1" max="120">
      </div>
      
      <div class="form-group">
        <label class="form-label">Durchgefuehrte Massnahmen / Beratungsinhalte</label>
        <textarea class="form-textarea" id="docMeasures" placeholder="Detaillierte Beschreibung der durchgefuehrten Leistung..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Befinden / Zustand des Patienten</label>
        <textarea class="form-textarea" id="docCondition" placeholder="Aktueller Gesundheitszustand, Symptome, Vitalwerte..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Ergebnis / Vereinbarung</label>
        <textarea class="form-textarea" id="docOutcome" placeholder="Was wurde vereinbart? Naechste Schritte?"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Abrechnungsziffer (optional)</label>
        <input type="text" class="form-input" id="docBillingCode" placeholder="z.B. GOP 88220 oder SGB V">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('addDocModal')">Abbrechen</button>
      <button class="btn primary" onclick="submitDocumentation()">Speichern & Abrechnen</button>
    </div>
  </div>
</div>

<!-- Handover Modal -->
<div class="modal" id="handoverModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ”„ Dienstubergabe erstellen</h3>
      <button class="close-btn" onclick="closeModal('handoverModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="alert-box info">
        <span style="font-size: 1.5em;">â„¹ï¸</span>
        <div>Uebergabe an die naechste Schicht. Alle offenen Faelle und wichtigen Informationen dokumentieren.</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Uebergabe an</label>
        <select class="form-select" id="handoverTo">
          <option>Spaetdienst (14:00-22:00)</option>
          <option>Nachtdienst (22:00-06:00)</option>
          <option>Fruhdienst (06:00-14:00)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Offene Rueckrufe / To-Dos</label>
        <textarea class="form-textarea" id="handoverTodos" placeholder="Welche Patienten muessen kontaktiert werden? Was ist zu erledigen?"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Kritische Patienten / Besonderheiten</label>
        <textarea class="form-textarea" id="handoverCritical" placeholder="Hochrisiko-Patienten, besondere Vorkommnisse..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Weiterleitungen / Eskalationen</label>
        <textarea class="form-textarea" id="handoverEscalations" placeholder="Welche Patienten wurden an Aerzte weitergeleitet?"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Sonstiges</label>
        <textarea class="form-textarea" id="handoverNotes" placeholder="Weitere wichtige Informationen..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('handoverModal')">Abbrechen</button>
      <button class="btn primary" onclick="submitHandover()">Uebergabe speichern</button>
    </div>
  </div>
</div>

<!-- Callback Modal -->
<div class="modal" id="callbackModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“ Rueckruf planen</h3>
      <button class="close-btn" onclick="closeModal('callbackModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Rueckruf-Zeitpunkt</label>
        <select class="form-select" id="callbackTime">
          <option value="1">In 1 Stunde</option>
          <option value="2">In 2 Stunden</option>
          <option value="4">In 4 Stunden</option>
          <option value="24">Morgen (24h)</option>
          <option value="48">In 2 Tagen</option>
          <option value="168">In 1 Woche</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Grund fuer Rueckruf</label>
        <textarea class="form-textarea" id="callbackReason" placeholder="Warum soll der Patient zurueckgerufen werden?"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Prioritaet</label>
        <select class="form-select" id="callbackPriority">
          <option value="low">Niedrig - Routine</option>
          <option value="medium">Mittel - Wichtig</option>
          <option value="high">Hoch - Dringend</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('callbackModal')">Abbrechen</button>
      <button class="btn primary" onclick="submitCallback()">Rueckruf planen</button>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div class="modal" id="noteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“ Interne Notiz</h3>
      <button class="close-btn" onclick="closeModal('noteModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="alert-box info">
        <span style="font-size: 1.5em;">ğŸ”’</span>
        <div>Interne Notizen sind nur fuer das KLIBIZ-Team sichtbar, nicht fuer den Patienten.</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Notiz</label>
        <textarea class="form-textarea" id="noteText" placeholder="Interne Informationen, Beobachtungen, Hinweise fuer Kollegen..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('noteModal')">Abbrechen</button>
      <button class="btn primary" onclick="submitNote()">Notiz speichern</button>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modal" id="feedbackModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>â­ Patienten-Feedback</h3>
      <button class="close-btn" onclick="closeModal('feedbackModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="alert-box success">
        <span style="font-size: 1.5em;">ğŸ“Š</span>
        <div>Feedback zur Qualitaetssicherung und Verbesserung der Betreuung.</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Zufriedenheit (1-5 Sterne)</label>
        <select class="form-select" id="feedbackRating">
          <option value="5">â­â­â­â­â­ Sehr zufrieden</option>
          <option value="4">â­â­â­â­ Zufrieden</option>
          <option value="3">â­â­â­ Neutral</option>
          <option value="2">â­â­ Weniger zufrieden</option>
          <option value="1">â­ Unzufrieden</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Kommentar</label>
        <textarea class="form-textarea" id="feedbackComment" placeholder="Was hat dem Patienten besonders gut/schlecht gefallen?"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Outcome</label>
        <select class="form-select" id="feedbackOutcome">
          <option value="success">âœ… Erfolgreich - Keine Wiederaufnahme</option>
          <option value="readmission">ğŸ¥ Wiederaufnahme erfolgt</option>
          <option value="transferred">ğŸ”„ An Hausarzt uebergeben</option>
          <option value="continuing">â³ Betreuung wird fortgesetzt</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('feedbackModal')">Abbrechen</button>
      <button class="btn primary" onclick="submitFeedback()">Feedback speichern</button>
    </div>
  </div>
</div>

<!-- Phone/Video Call Modal -->
<div class="modal" id="callModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="callTitle">ğŸ“ Anruf</h3>
      <button class="close-btn" onclick="closeModal('callModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 3em; margin-bottom: 20px;" id="callIcon">ğŸ“</div>
        <div style="font-size: 1.2em; margin-bottom: 10px;">Verbindung zu</div>
        <div style="font-size: 1.5em; font-weight: 600; color: #e20074;" id="callPatient"></div>
        <div style="margin-top: 30px; color: #666;">Bitte warten...</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn danger" onclick="endCall()">Beenden</button>
    </div>
  </div>
</div>

<script>
const patients = {
  'P001': {
    id: 'R2025-001', name: 'Maria Mueller', diagnose: 'Herzinsuffizienz NYHA III',
    entlass: '14.10.2025', compliance: 85, riskScore: 35, riskLevel: 'low', archived: false,
    lastContact: new Date('2025-10-18T10:15:00'),
    messages: [
      {sender: 'patient', text: 'Guten Morgen! Gewicht heute: 78,5 kg (-500g)', time: '2025-10-18T07:30:00'},
      {sender: 'nurse', text: 'Super Frau Mueller! Wie fuehlen Sie sich?', time: '2025-10-18T07:35:00'},
      {sender: 'patient', text: 'Viel besser, die Atemnot ist weg.', time: '2025-10-18T07:40:00'},
      {sender: 'system', text: 'ğŸ“ Telefonanruf - 12 Minuten', time: '2025-10-17T15:00:00'},
      {sender: 'system', text: 'ğŸ“¹ Videoanruf - 8 Minuten', time: '2025-10-16T10:30:00'}
    ],
    documentation: [
      {
        id: 1,
        date: '2025-10-18T07:35:00',
        type: 'chatberatung',
        typeName: 'Chat-basierte Beratung',
        duration: 15,
        measures: 'Beratung zu Gewichtsentwicklung und Symptomkontrolle bei Herzinsuffizienz',
        condition: 'Patient berichtet deutliche Besserung, Gewichtsreduktion um 500g, keine Atemnot mehr',
        outcome: 'Patient soll weiter taeglich Gewicht kontrollieren, bei Zunahme >1kg melden',
        billingCode: 'SGB V Telemedizin',
        revenue: 18.50,
        nurse: 'M. Muehlbach'
      },
      {
        id: 2,
        date: '2025-10-17T15:00:00',
        type: 'telefonberatung',
        typeName: 'Telefonische Beratung',
        duration: 12,
        measures: 'Symptomabklaerung, Medikationsberatung, Vitalwertkontrolle',
        condition: 'RR 125/80, Puls 72, leichte Dyspnoe bei Belastung',
        outcome: 'Diuretika-Dosis beibehalten, engmaschige Gewichtskontrolle',
        billingCode: 'GOP 88220',
        revenue: 24.80,
        nurse: 'M. Muehlbach'
      },
      {
        id: 3,
        date: '2025-10-16T10:30:00',
        type: 'videosprechstunde',
        typeName: 'Videosprechstunde',
        duration: 8,
        measures: 'Visuelle Beurteilung Oedeme, Mobilisation, allgemeiner Zustand',
        condition: 'Knoecheloedeme regredient, Mobilisation gut',
        outcome: 'Fortfuehrung Therapie, naechster Kontakt in 2 Tagen',
        billingCode: 'GOP 01450',
        revenue: 32.40,
        nurse: 'M. Muehlbach'
      }
    ],
    pegasos: {fallnummer: 'R2025-1234567', diagnosen: ['Herzinsuffizienz NYHA III'], station: 'Kardiologie 3A'}
  },
  'P002': {
    id: 'R2025-002', name: 'Karl Schmidt', diagnose: 'Post-OP Hueft-TEP',
    entlass: '10.10.2025', compliance: 65, riskScore: 72, riskLevel: 'high', archived: false,
    lastContact: new Date('2025-10-17T14:22:00'),
    messages: [
      {sender: 'patient', text: 'Die Wunde schmerzt stark, sehr rot.', time: '2025-10-17T10:30:00'},
      {sender: 'nurse', text: 'Bitte senden Sie ein Foto.', time: '2025-10-17T10:35:00'},
      {sender: 'patient', text: 'Hier das Foto:', image: 'https://images.unsplash.com/photo-1584362917165-526a968579e8?w=300&h=200&fit=crop', time: '2025-10-17T10:45:00'},
      {sender: 'nurse', text: 'Ich leite Sie an die Chirurgie weiter.', time: '2025-10-17T10:50:00'},
      {sender: 'system', text: 'ğŸ“ Telefonanruf - 18 Minuten', time: '2025-10-17T11:00:00'}
    ],
    documentation: [
      {
        id: 1,
        date: '2025-10-17T10:35:00',
        type: 'wundbeurteilung',
        typeName: 'Wundbeurteilung (Foto-basiert)',
        duration: 20,
        measures: 'Beurteilung postoperativer Wunde anhand Patientenfoto, Beratung zu Wundversorgung',
        condition: 'Wunde geroetel, ueberwaermt, Patient berichtet Schmerzen (VAS 7/10), Verdacht auf Wundinfektion',
        outcome: 'Weiterleitung an chirurgische Ambulanz, Patient soll heute vorstellig werden',
        billingCode: 'GOP 02310',
        revenue: 24.00,
        nurse: 'M. Muehlbach'
      },
      {
        id: 2,
        date: '2025-10-17T11:00:00',
        type: 'eskalation',
        typeName: 'Eskalation / Weiterleitung',
        duration: 15,
        measures: 'Koordination mit chirurgischer Ambulanz, Uebermittlung Befunde und Fotos',
        condition: 'Verdacht Wundinfektion, Fieber 38,2Â°C',
        outcome: 'Patient fuer heute in Chirurgie angemeldet, Arzt informiert',
        billingCode: 'Koordination',
        revenue: 18.00,
        nurse: 'M. Muehlbach'
      }
    ],
    pegasos: {fallnummer: 'R2025-2345678', diagnosen: ['Z.n. Hueft-TEP'], station: 'Chirurgie 2B'}
  },
  'P003': {
    id: 'R2025-003', name: 'Petra Bauer', diagnose: 'Diabetes Typ 2',
    entlass: '12.10.2025', compliance: 78, riskScore: 55, riskLevel: 'medium', archived: false,
    lastContact: new Date('2025-10-18T08:15:00'),
    messages: [
      {sender: 'patient', text: 'Blutzucker nuechtern: 145 mg/dl', time: '2025-10-18T07:00:00'},
      {sender: 'nurse', text: 'Etwas hoch. Gestern Suesses gegessen?', time: '2025-10-18T07:05:00'},
      {sender: 'patient', text: 'Ja, Geburtstag gehabt.', time: '2025-10-18T07:10:00'},
      {sender: 'system', text: 'ğŸ“¹ Videoanruf - 15 Minuten', time: '2025-10-17T14:00:00'}
    ],
    pegasos: {fallnummer: 'R2025-3456789', diagnosen: ['Diabetes mellitus Typ 2'], station: 'Endokrinologie 4A'}
  },
  'P004': {
    id: 'R2025-004', name: 'Hans Meier', diagnose: 'COPD Gold III',
    entlass: '08.10.2025', compliance: 42, riskScore: 88, riskLevel: 'high', archived: false,
    lastContact: new Date('2025-10-16T11:30:00'),
    messages: [
      {sender: 'nurse', text: 'Herr Meier, bitte melden Sie sich!', time: '2025-10-16T09:00:00'},
      {sender: 'nurse', text: 'Dringend: Kontaktieren Sie uns!', time: '2025-10-17T10:00:00'}
    ],
    pegasos: {fallnummer: 'R2025-4567890', diagnosen: ['COPD Gold III'], station: 'Pneumologie 5A'}
  },
  'P005': {
    id: 'R2025-005', name: 'Ingrid Wagner', diagnose: 'Schlaganfall',
    entlass: '15.10.2025', compliance: 91, riskScore: 28, riskLevel: 'low', archived: false,
    lastContact: new Date('2025-10-18T09:00:00'),
    messages: [
      {sender: 'patient', text: 'Physiotherapie gemacht, fuehlt sich gut an!', time: '2025-10-18T09:00:00'},
      {sender: 'nurse', text: 'Sehr gut! Weiter so!', time: '2025-10-18T09:05:00'},
      {sender: 'system', text: 'ğŸ“¹ Videoanruf - 20 Minuten - Gangschulung', time: '2025-10-17T10:00:00'}
    ],
    pegasos: {fallnummer: 'R2025-5678901', diagnosen: ['Ischaemischer Insult'], station: 'Neurologie 6B'}
  },
  'P006': {
    id: 'R2025-006', name: 'Werner Krause', diagnose: 'Niereninsuffizienz',
    entlass: '11.10.2025', compliance: 73, riskScore: 48, riskLevel: 'medium', archived: false,
    lastContact: new Date('2025-10-18T07:45:00'),
    messages: [
      {sender: 'patient', text: 'Trinkmenge: 1,2 Liter gestern', time: '2025-10-18T07:45:00'},
      {sender: 'nurse', text: 'Perfekt! Weiter so.', time: '2025-10-18T07:50:00'},
      {sender: 'system', text: 'ğŸ“ Telefonanruf - 10 Minuten', time: '2025-10-17T16:00:00'}
    ],
    pegasos: {fallnummer: 'R2025-6789012', diagnosen: ['Chronische Niereninsuffizienz'], station: 'Nephrologie 3B'}
  },
  'P007': {
    id: 'R2025-007', name: 'Sabine Hoffmann', diagnose: 'Pneumonie',
    entlass: '13.10.2025', compliance: 88, riskScore: 32, riskLevel: 'low', archived: false,
    lastContact: new Date('2025-10-18T08:30:00'),
    messages: [
      {sender: 'patient', text: 'Fieber weg, Husten besser!', time: '2025-10-18T08:30:00'},
      {sender: 'nurse', text: 'Wunderbar! Bitte weiter inhalieren.', time: '2025-10-18T08:35:00'},
      {sender: 'system', text: 'ğŸ“¹ Videoanruf - 12 Minuten', time: '2025-10-17T11:00:00'}
    ],
    pegasos: {fallnummer: 'R2025-7890123', diagnosen: ['Ambulant erworbene Pneumonie'], station: 'Pneumologie 5B'}
  },
  'P008': {
    id: 'R2025-008', name: 'Thomas Richter', diagnose: 'Ulcus cruris',
    entlass: '09.10.2025', compliance: 81, riskScore: 41, riskLevel: 'medium', archived: false,
    lastContact: new Date('2025-10-18T10:00:00'),
    messages: [
      {sender: 'patient', text: 'Wundfoto von heute:', image: 'https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=300&h=200&fit=crop', time: '2025-10-18T10:00:00'},
      {sender: 'nurse', text: 'Wunde heilt gut ab!', time: '2025-10-18T10:05:00'},
      {sender: 'system', text: 'ğŸ“ Telefonanruf - 15 Minuten', time: '2025-10-17T13:00:00'}
    ],
    pegasos: {fallnummer: 'R2025-8901234', diagnosen: ['Ulcus cruris venosum'], station: 'Dermatologie 2A'}
  },
  'P009': {
    id: 'R2025-009', name: 'Monika Schulz', diagnose: 'Hyperthyreose',
    entlass: '16.10.2025', compliance: 76, riskScore: 38, riskLevel: 'low', archived: false,
    lastContact: new Date('2025-10-18T09:30:00'),
    messages: [
      {sender: 'patient', text: 'Herzrasen heute Nacht', time: '2025-10-18T09:30:00'},
      {sender: 'nurse', text: 'Thiamazol eingenommen?', time: '2025-10-18T09:32:00'},
      {sender: 'patient', text: 'Ja, regelmaessig.', time: '2025-10-18T09:35:00'},
      {sender: 'system', text: 'ğŸ“¹ Videoanruf - 18 Minuten', time: '2025-10-17T15:30:00'}
    ],
    pegasos: {fallnummer: 'R2025-9012345', diagnosen: ['Hyperthyreose'], station: 'Endokrinologie 4B'}
  },
  'P010': {
    id: 'R2025-010', name: 'Helga Fischer', diagnose: 'Hypertonie',
    entlass: '05.10.2025', compliance: 95, riskScore: 15, riskLevel: 'low', archived: true,
    lastContact: new Date('2025-10-10T15:00:00'),
    messages: [
      {sender: 'patient', text: 'Vielen Dank fuer alles!', time: '2025-10-10T15:00:00'},
      {sender: 'nurse', text: 'Gerne! Alles Gute!', time: '2025-10-10T15:05:00'}
    ],
    pegasos: {fallnummer: 'R2025-0123456', diagnosen: ['Arterielle Hypertonie'], station: 'Kardiologie 3B'}
  }
};

let currentPatient = null;
let currentFilter = 'all';

// Globale Team-Daten
const teamData = {
  handovers: [
    {id: 1, date: '2025-10-18T14:00:00', from: 'M. Muehlbach', to: 'Spaetdienst', todos: 'Hans Meier zurueckrufen - seit 50h inaktiv', critical: 'Karl Schmidt - Wundinfektion, heute in Chirurgie', escalations: 'Maria Mueller - stabil'},
    {id: 2, date: '2025-10-17T14:00:00', from: 'K. Weber', to: 'Spaetdienst', todos: 'Petra Bauer - Blutzuckerkontrolle', critical: 'Hans Meier kontaktieren', escalations: 'Keine'}
  ],
  callbacks: [],
  notes: {},
  feedbacks: {},
  stats: {
    totalPatients: 10,
    activeToday: 7,
    callsToday: 12,
    avgResponseTime: 8,
    preventedReadmissions: 4,
    satisfactionScore: 4.6
  }
};

document.addEventListener('DOMContentLoaded', () => {
  renderPatientList();
  initEventListeners();
});

function initEventListeners() {
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.dataset.filter;
      renderPatientList();
    });
  });

  document.getElementById('searchBox').addEventListener('input', (e) => {
    renderPatientList(e.target.value);
  });

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      e.target.classList.add('active');
      const tabName = e.target.dataset.tab;
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      if (currentPatient) {
        if (tabName === 'documentation') renderDocumentation();
        if (tabName === 'handover') renderHandover();
        if (tabName === 'callbacks') renderCallbacks();
        if (tabName === 'team') renderTeam();
        if (tabName === 'quality') renderQuality();
        if (tabName === 'vitals') renderVitals();
        if (tabName === 'meds') renderMedication();
        if (tabName === 'wounds') renderWounds();
        if (tabName === 'tasks') renderTasks();
      }
    });
  });

  document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
}

function renderPatientList(searchTerm = '') {
  const list = document.getElementById('patientList');
  list.innerHTML = '';

  const filtered = Object.values(patients).filter(p => {
    const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                          p.id.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesFilter = 
      currentFilter === 'all' && !p.archived ||
      (currentFilter === 'high-risk' && p.riskLevel === 'high' && !p.archived) ||
      (currentFilter === 'medium-risk' && p.riskLevel === 'medium' && !p.archived) ||
      (currentFilter === 'low-risk' && p.riskLevel === 'low' && !p.archived) ||
      (currentFilter === 'archived' && p.archived);
    return matchesSearch && matchesFilter;
  });

  filtered.sort((a, b) => b.riskScore - a.riskScore);

  filtered.forEach(patient => {
    const card = document.createElement('div');
    card.className = 'patient-card';
    if (patient.archived) card.classList.add('archived');
    if (currentPatient && patient.id === currentPatient.id) card.classList.add('active');

    card.innerHTML = `
      <div class="risk-indicator risk-${patient.riskLevel}"></div>
      <div class="patient-name">${patient.name}</div>
      <div class="patient-diagnose">${patient.diagnose}</div>
      <div class="patient-id">Fallnr: ${patient.id}</div>
      <div class="risk-badge ${patient.riskLevel}">Risiko: ${patient.riskScore}</div>
      <div class="patient-meta">
        <span>${formatRelativeTime(patient.lastContact)}</span>
        <span>${patient.messages.length} ğŸ’¬</span>
      </div>
    `;

    card.addEventListener('click', () => selectPatient(patient.id));
    list.appendChild(card);
  });
}

function selectPatient(patientId) {
  currentPatient = Object.values(patients).find(p => p.id === patientId);
  
  document.getElementById('patientName').textContent = currentPatient.name;
  document.getElementById('statusText').textContent = `Risiko: ${currentPatient.riskScore} | ${currentPatient.diagnose}`;
  document.getElementById('actionButtons').style.display = 'flex';
  document.getElementById('chatInputArea').style.display = 'flex';
  document.getElementById('infoPanel').style.display = 'block';
  
  document.getElementById('infoId').textContent = currentPatient.id;
  document.getElementById('infoDiagnose').textContent = currentPatient.diagnose;
  document.getElementById('infoEntlass').textContent = currentPatient.entlass;
  document.getElementById('infoRisk').innerHTML = `<span style="color: ${getRiskColor(currentPatient.riskLevel)}; font-weight: 700;">${currentPatient.riskScore}</span>`;
  
  // Buttons in Info-Panel
  const infoPanel = document.getElementById('infoPanel');
  const buttonsHtml = `
    <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
      <button class="btn primary" style="width: 100%;" onclick="openCallbackModal()">ğŸ“ Rueckruf planen</button>
      <button class="btn" style="width: 100%;" onclick="openNoteModal()">ğŸ“ Notiz hinzufuegen</button>
      <button class="btn" style="width: 100%;" onclick="openFeedbackModal()">â­ Feedback erfassen</button>
    </div>
  `;
  
  if (!document.getElementById('infoPanelButtons')) {
    const div = document.createElement('div');
    div.id = 'infoPanelButtons';
    div.innerHTML = buttonsHtml;
    infoPanel.appendChild(div);
  }
  
  renderMessages();
  renderPatientList();
}

function renderMessages() {
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML = '';

  currentPatient.messages.forEach(msg => {
    const div = document.createElement('div');
    div.className = `message from-${msg.sender}`;
    
    let content = '';
    if (msg.sender === 'system') {
      content = `<div class="message-text">${msg.text}</div>`;
    } else {
      const icon = msg.sender === 'patient' ? 'ğŸ‘¤' : 'ğŸ‘¨â€âš•ï¸';
      const sender = msg.sender === 'patient' ? currentPatient.name : 'KLIBIZ';
      content = `
        <div class="message-sender">${icon} ${sender}</div>
        <div class="message-text">${msg.text}</div>
        ${msg.image ? `<img src="${msg.image}" class="message-image">` : ''}
        <div class="message-time">${formatTime(msg.time)}</div>
      `;
    }
    
    div.innerHTML = content;
    chatMessages.appendChild(div);
  });
  
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text || !currentPatient) return;

  currentPatient.messages.push({
    sender: 'nurse',
    text: text,
    time: new Date().toISOString()
  });

  renderMessages();
  input.value = '';
}

function renderVitals() {
  const container = document.getElementById('vitalsContainer');
  container.innerHTML = `
    <h3>ğŸ“ˆ Vitalparameter-Verlauf</h3>
    <div class="vitals-chart">
      <h4>Gewichtsverlauf (letzte 7 Tage)</h4>
      <div class="chart-bars">
        ${[82, 81.5, 81, 80.5, 80, 79.5, 79].map((w, i) => `
          <div class="chart-bar" style="height: ${w}%; min-height: 40px;">
            <span>${w}kg</span>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="vitals-chart">
      <h4>Blutdruckverlauf</h4>
      <div class="chart-bars">
        ${[145, 142, 138, 135, 132, 130, 128].map((bp, i) => `
          <div class="chart-bar" style="height: ${(bp/180)*100}%; min-height: 40px;">
            <span>${bp}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderMedication() {
  const container = document.getElementById('medsContainer');
  container.innerHTML = `
    <h3>ğŸ’Š Medikationsplan</h3>
    <div class="alert-box info">
      <span>â„¹ï¸</span>
      <div>Medikationsabgleich: Alle Medikamente aus PEGASOS stimmen mit aktueller Einnahme ueberein.</div>
    </div>
    <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 12px;">
      <h4>Aktuelle Medikation</h4>
      <div style="margin-top: 15px;">
        <div style="padding: 12px; background: #f5f5f5; margin: 8px 0; border-radius: 8px;">
          <strong>Torasemid 20mg</strong> - 1-0-0 - âœ… Eingenommen
        </div>
        <div style="padding: 12px; background: #f5f5f5; margin: 8px 0; border-radius: 8px;">
          <strong>Ramipril 5mg</strong> - 1-0-0 - âœ… Eingenommen
        </div>
        <div style="padding: 12px; background: #f5f5f5; margin: 8px 0; border-radius: 8px;">
          <strong>Bisoprolol 2,5mg</strong> - 1-0-0 - âœ… Eingenommen
        </div>
      </div>
    </div>
  `;
}

function renderWounds() {
  const container = document.getElementById('woundsContainer');
  container.innerHTML = `
    <h3>ğŸ©¹ Wundverlauf</h3>
    <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 12px;">
      <h4>Ulcus cruris rechts</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
        <div>
          <div style="font-weight: 600; margin-bottom: 8px;">Vorher (10.10.2025)</div>
          <img src="https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=300&h=200&fit=crop" style="width: 100%; border-radius: 8px;">
          <div style="margin-top: 8px; color: #666;">Groesse: 4,5 x 3,2 cm</div>
        </div>
        <div>
          <div style="font-weight: 600; margin-bottom: 8px;">Nachher (18.10.2025)</div>
          <img src="https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=300&h=200&fit=crop" style="width: 100%; border-radius: 8px;">
          <div style="margin-top: 8px; color: #666;">Groesse: 3,2 x 2,1 cm</div>
        </div>
      </div>
      <div class="alert-box" style="background: #e8f5e9; border-left: 4px solid #4caf50; margin-top: 20px;">
        <span>âœ…</span>
        <div>Wunde regredient, gute Granulation</div>
      </div>
    </div>
  `;
}

function renderTasks() {
  const container = document.getElementById('tasksContainer');
  container.innerHTML = `
    <h3>ğŸ“‹ Aufgaben</h3>
    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #4caf50;">
      <strong>Gewicht messen</strong>
      <div style="font-size: 0.85em; color: #666; margin-top: 5px;">âœ… Erledigt - Heute 07:00 Uhr</div>
    </div>
    <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid #ff9800;">
      <strong>Blutdruck messen</strong>
      <div style="font-size: 0.85em; color: #666; margin-top: 5px;">â³ Ausstehend - Heute 19:00 Uhr</div>
    </div>
  `;
}

function renderDocumentation() {
  if (!currentPatient || !currentPatient.documentation) return;
  
  const docs = currentPatient.documentation;
  const totalMinutes = docs.reduce((sum, doc) => sum + doc.duration, 0);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  const totalRevenue = docs.reduce((sum, doc) => sum + doc.revenue, 0);
  const chatCount = docs.filter(d => d.type === 'chatberatung').length;
  const callCount = docs.filter(d => d.type === 'telefonberatung' || d.type === 'videosprechstunde').length;
  
  document.getElementById('docTotalTime').textContent = `${hours}h ${minutes}m`;
  document.getElementById('docChats').textContent = chatCount;
  document.getElementById('docCalls').textContent = callCount;
  document.getElementById('docRevenue').textContent = totalRevenue.toFixed(2) + ' â‚¬';
  
  const list = document.getElementById('documentationList');
  list.innerHTML = '<h4 style="margin: 25px 0 15px 0;">Leistungshistorie</h4>';
  
  docs.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(doc => {
    const docCard = document.createElement('div');
    docCard.style.cssText = 'background: white; padding: 20px; margin: 12px 0; border-radius: 12px; border-left: 4px solid #2196f3; box-shadow: 0 2px 8px rgba(0,0,0,0.05);';
    
    docCard.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
        <div>
          <strong style="font-size: 1.1em;">${doc.typeName}</strong>
          <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${formatDateTime(doc.date)} | ${doc.nurse}</div>
        </div>
        <div style="text-align: right;">
          <div style="background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 8px; font-weight: 600; font-size: 0.9em;">
            ${doc.duration} Min.
          </div>
          <div style="font-size: 0.85em; color: #666; margin-top: 5px;">${doc.revenue.toFixed(2)} â‚¬</div>
        </div>
      </div>
      
      <div style="margin: 12px 0; padding: 12px; background: #f5f5f5; border-radius: 8px;">
        <strong style="color: #333;">Durchgefuehrte Massnahmen:</strong>
        <div style="margin-top: 5px; color: #666; line-height: 1.6;">${doc.measures}</div>
      </div>
      
      <div style="margin: 12px 0; padding: 12px; background: #f5f5f5; border-radius: 8px;">
        <strong style="color: #333;">Befinden / Zustand:</strong>
        <div style="margin-top: 5px; color: #666; line-height: 1.6;">${doc.condition}</div>
      </div>
      
      <div style="margin: 12px 0; padding: 12px; background: #f5f5f5; border-radius: 8px;">
        <strong style="color: #333;">Ergebnis / Vereinbarung:</strong>
        <div style="margin-top: 5px; color: #666; line-height: 1.6;">${doc.outcome}</div>
      </div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0; font-size: 0.85em; color: #999;">
        <span>Abrechnungsziffer: <strong style="color: #333;">${doc.billingCode}</strong></span>
        <span>Dokumentations-ID: ${doc.id}</span>
      </div>
    `;
    
    list.appendChild(docCard);
  });
}

function openAddDocumentation() {
  if (!currentPatient) return;
  
  document.getElementById('docType').value = '';
  document.getElementById('docDuration').value = '15';
  document.getElementById('docMeasures').value = '';
  document.getElementById('docCondition').value = '';
  document.getElementById('docOutcome').value = '';
  document.getElementById('docBillingCode').value = '';
  
  openModal('addDocModal');
}

function updateDocTemplate() {
  const type = document.getElementById('docType').value;
  const templates = {
    'telefonberatung': {duration: 20, billing: 'GOP 88220'},
    'videosprechstunde': {duration: 30, billing: 'GOP 01450'},
    'chatberatung': {duration: 15, billing: 'SGB V Telemedizin'},
    'symptomabklaerung': {duration: 20, billing: 'SGB V Triagierung'},
    'medikationsberatung': {duration: 25, billing: 'GOP 01430'},
    'wundbeurteilung': {duration: 20, billing: 'GOP 02310'},
    'schulung': {duration: 40, billing: 'SGB V Schulung'},
    'krisenintervention': {duration: 45, billing: 'GOP 21210'},
    'eskalation': {duration: 15, billing: 'Koordination'},
    'angehoerigengespraech': {duration: 30, billing: 'GOP 01440'}
  };
  
  if (templates[type]) {
    document.getElementById('docDuration').value = templates[type].duration;
    document.getElementById('docBillingCode').value = templates[type].billing;
  }
}

function submitDocumentation() {
  const type = document.getElementById('docType').value;
  const duration = parseInt(document.getElementById('docDuration').value);
  const measures = document.getElementById('docMeasures').value;
  const condition = document.getElementById('docCondition').value;
  const outcome = document.getElementById('docOutcome').value;
  const billingCode = document.getElementById('docBillingCode').value;
  
  if (!type || !duration || !measures || !condition || !outcome) {
    alert('Bitte fuellen Sie alle Pflichtfelder aus!');
    return;
  }
  
  if (!currentPatient.documentation) {
    currentPatient.documentation = [];
  }
  
  const typeNames = {
    'telefonberatung': 'Telefonische Beratung',
    'videosprechstunde': 'Videosprechstunde',
    'chatberatung': 'Chat-basierte Beratung',
    'symptomabklaerung': 'Symptomabklaerung / Triagierung',
    'medikationsberatung': 'Medikationsberatung',
    'wundbeurteilung': 'Wundbeurteilung',
    'schulung': 'Patientenschulung',
    'krisenintervention': 'Krisenintervention',
    'eskalation': 'Eskalation / Weiterleitung',
    'angehoerigengespraech': 'Angehoerigengespraech'
  };
  
  // Einfache Erloes-Berechnung (Durchschnitt ca. 1,20 â‚¬ pro Minute)
  const revenue = duration * 1.20;
  
  const newDoc = {
    id: currentPatient.documentation.length + 1,
    date: new Date().toISOString(),
    type: type,
    typeName: typeNames[type],
    duration: duration,
    measures: measures,
    condition: condition,
    outcome: outcome,
    billingCode: billingCode,
    revenue: revenue,
    nurse: 'M. Muehlbach'
  };
  
  currentPatient.documentation.push(newDoc);
  
  alert(`Leistung erfolgreich dokumentiert!\n\nDauer: ${duration} Min.\nGeschaetzter ErloÃ©s: ${revenue.toFixed(2)} â‚¬\n\nDie Dokumentation wurde an das Controlling uebermittelt.`);
  
  closeModal('addDocModal');
  renderDocumentation();
}

function exportDocumentation() {
  if (!currentPatient || !currentPatient.documentation) {
    alert('Keine Dokumentation vorhanden');
    return;
  }
  
  let csvContent = "Datum;Patient;Fallnummer;Leistung;Dauer (Min);Massnahmen;Befinden;Ergebnis;Abrechnungsziffer;ErloÃ©s (EUR);Pflegekraft\n";
  
  currentPatient.documentation.forEach(doc => {
    csvContent += `${formatDateTime(doc.date)};${currentPatient.name};${currentPatient.id};${doc.typeName};${doc.duration};${doc.measures.replace(/\n/g, ' ')};${doc.condition.replace(/\n/g, ' ')};${doc.outcome.replace(/\n/g, ' ')};${doc.billingCode};${doc.revenue.toFixed(2)};${doc.nurse}\n`;
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `KLIBIZ_Leistungsnachweis_${currentPatient.name}_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert('Leistungsdokumentation erfolgreich exportiert!\n\nDie CSV-Datei kann ans Controlling/Abrechnung weitergeleitet werden.');
}

function renderHandover() {
  const container = document.getElementById('handoverContainer');
  container.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>ğŸ”„ Dienstubergabe-Protokoll</h3>
      <button class="btn primary" onclick="openModal('handoverModal')">+ Neue Uebergabe</button>
    </div>
    
    <div class="alert-box info">
      <span style="font-size: 1.5em;">ğŸ“‹</span>
      <div>Alle Dienstubergaben werden protokolliert fuer lueckenlose Dokumentation und Qualitaetssicherung.</div>
    </div>
    
    <h4 style="margin: 25px 0 15px 0;">Uebergabe-Historie</h4>
    ${teamData.handovers.map(h => `
      <div style="background: white; padding: 20px; margin: 12px 0; border-radius: 12px; border-left: 4px solid #2196f3;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <div>
            <strong>${formatDateTime(h.date)}</strong>
            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">Von: ${h.from} â†’ An: ${h.to}</div>
          </div>
        </div>
        
        <div style="margin: 10px 0;">
          <strong>ğŸ“‹ Offene To-Dos:</strong>
          <div style="color: #666; margin-top: 5px;">${h.todos}</div>
        </div>
        
        <div style="margin: 10px 0;">
          <strong>âš ï¸ Kritische Patienten:</strong>
          <div style="color: #666; margin-top: 5px;">${h.critical}</div>
        </div>
        
        <div style="margin: 10px 0;">
          <strong>ğŸ”„ Weiterleitungen:</strong>
          <div style="color: #666; margin-top: 5px;">${h.escalations}</div>
        </div>
      </div>
    `).join('')}
  `;
}

function submitHandover() {
  const to = document.getElementById('handoverTo').value;
  const todos = document.getElementById('handoverTodos').value;
  const critical = document.getElementById('handoverCritical').value;
  const escalations = document.getElementById('handoverEscalations').value;
  const notes = document.getElementById('handoverNotes').value;
  
  if (!todos || !critical) {
    alert('Bitte fuellen Sie mindestens die Felder fuer To-Dos und kritische Patienten aus');
    return;
  }
  
  teamData.handovers.unshift({
    id: teamData.handovers.length + 1,
    date: new Date().toISOString(),
    from: 'M. Muehlbach',
    to: to,
    todos: todos,
    critical: critical,
    escalations: escalations,
    notes: notes
  });
  
  alert('Dienstubergabe erfolgreich erstellt!\n\nDie naechste Schicht wurde informiert.');
  closeModal('handoverModal');
  
  document.getElementById('handoverTodos').value = '';
  document.getElementById('handoverCritical').value = '';
  document.getElementById('handoverEscalations').value = '';
  document.getElementById('handoverNotes').value = '';
}

function renderCallbacks() {
  const container = document.getElementById('callbacksContainer');
  
  const allCallbacks = [];
  Object.values(patients).forEach(p => {
    if (teamData.callbacks) {
      teamData.callbacks.filter(cb => cb.patientId === p.id).forEach(cb => {
        allCallbacks.push({...cb, patient: p});
      });
    }
  });
  
  allCallbacks.sort((a, b) => new Date(a.time) - new Date(b.time));
  
  container.innerHTML = `
    <h3>ğŸ“ Geplante Rueckrufe</h3>
    
    <div class="alert-box warning">
      <span style="font-size: 1.5em;">â°</span>
      <div>Automatische Erinnerungen fuer faellige Rueckrufe. Nie wieder einen Follow-up verpassen!</div>
    </div>
    
    ${allCallbacks.length === 0 ? '<div class="empty-state"><div style="font-size: 4em;">ğŸ“</div><p>Keine offenen Rueckrufe</p></div>' : ''}
    
    ${allCallbacks.map(cb => `
      <div style="background: white; padding: 15px; margin: 12px 0; border-radius: 10px; border-left: 4px solid ${cb.priority === 'high' ? '#f44336' : cb.priority === 'medium' ? '#ff9800' : '#4caf50'};">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${cb.patient.name}</strong> (${cb.patient.id})
            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">${cb.reason}</div>
            <div style="font-size: 0.75em; color: #999; margin-top: 3px;">Faellig: ${formatDateTime(cb.time)}</div>
          </div>
          <button class="btn primary" onclick="selectPatient('${cb.patient.id}'); makePhoneCall();">Jetzt anrufen</button>
        </div>
      </div>
    `).join('')}
  `;
}

function openCallbackModal() {
  if (!currentPatient) return;
  openModal('callbackModal');
}

function submitCallback() {
  const hours = parseInt(document.getElementById('callbackTime').value);
  const reason = document.getElementById('callbackReason').value;
  const priority = document.getElementById('callbackPriority').value;
  
  if (!reason) {
    alert('Bitte geben Sie einen Grund fuer den Rueckruf an');
    return;
  }
  
  const callbackTime = new Date();
  callbackTime.setHours(callbackTime.getHours() + hours);
  
  if (!teamData.callbacks) teamData.callbacks = [];
  
  teamData.callbacks.push({
    id: teamData.callbacks.length + 1,
    patientId: currentPatient.id,
    time: callbackTime.toISOString(),
    reason: reason,
    priority: priority,
    created: new Date().toISOString(),
    createdBy: 'M. Muehlbach'
  });
  
  alert(`Rueckruf erfolgreich geplant!\n\nZeitpunkt: ${formatDateTime(callbackTime)}\nPrioritaet: ${priority}`);
  closeModal('callbackModal');
  
  document.getElementById('callbackReason').value = '';
}

function renderTeam() {
  const container = document.getElementById('teamContainer');
  container.innerHTML = `
    <h3>ğŸ‘¥ Team-Dashboard</h3>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
      <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 2.5em; font-weight: 700; color: #e20074;">4</div>
        <div style="color: #666; font-size: 0.9em;">Aktive Pflegekraefte</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 2.5em; font-weight: 700; color: #2196f3;">${teamData.stats.activeToday}</div>
        <div style="color: #666; font-size: 0.9em;">Betreute Patienten heute</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 2.5em; font-weight: 700; color: #4caf50;">${teamData.stats.callsToday}</div>
        <div style="color: #666; font-size: 0.9em;">Beratungen heute</div>
      </div>
    </div>
    
    <h4 style="margin: 25px 0 15px 0;">Aktueller Schichtplan</h4>
    <div style="background: white; padding: 20px; border-radius: 12px;">
      <div style="padding: 12px; margin: 8px 0; background: #e8f5e9; border-radius: 8px;">
        <strong>Fruhdienst (06:00-14:00)</strong> - M. Muehlbach, K. Weber
      </div>
      <div style="padding: 12px; margin: 8px 0; background: #f5f5f5; border-radius: 8px;">
        <strong>Spaetdienst (14:00-22:00)</strong> - S. Mueller, T. Schmidt
      </div>
      <div style="padding: 12px; margin: 8px 0; background: #f5f5f5; border-radius: 8px;">
        <strong>Nachtdienst (22:00-06:00)</strong> - A. Fischer
      </div>
    </div>
    
    <h4 style="margin: 25px 0 15px 0;">Workload-Verteilung</h4>
    <div style="background: white; padding: 20px; border-radius: 12px;">
      <div style="margin: 12px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>M. Muehlbach</span>
          <span>4 Patienten</span>
        </div>
        <div style="background: #f5f5f5; height: 10px; border-radius: 5px;">
          <div style="background: #e20074; width: 80%; height: 100%; border-radius: 5px;"></div>
        </div>
      </div>
      <div style="margin: 12px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>K. Weber</span>
          <span>3 Patienten</span>
        </div>
        <div style="background: #f5f5f5; height: 10px; border-radius: 5px;">
          <div style="background: #2196f3; width: 60%; height: 100%; border-radius: 5px;"></div>
        </div>
      </div>
    </div>
  `;
}

function renderQuality() {
  const container = document.getElementById('qualityContainer');
  
  const stats = teamData.stats;
  
  container.innerHTML = `
    <h3>ğŸ“Š Qualitaets-KPIs & Outcome-Tracking</h3>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
      <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid #4caf50;">
        <div style="font-size: 2.5em; font-weight: 700; color: #4caf50;">${stats.preventedReadmissions}</div>
        <div style="color: #666; font-size: 0.9em; margin-top: 5px;">Vermiedene Wiederaufnahmen</div>
        <div style="font-size: 0.75em; color: #4caf50; margin-top: 5px;">â†— +1 diese Woche</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid #ff9800;">
        <div style="font-size: 2.5em; font-weight: 700; color: #ff9800;">${stats.avgResponseTime} Min</div>
        <div style="color: #666; font-size: 0.9em; margin-top: 5px;">Ã˜ Reaktionszeit</div>
        <div style="font-size: 0.75em; color: #4caf50; margin-top: 5px;">â†˜ -2 Min</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid #e20074;">
        <div style="font-size: 2.5em; font-weight: 700; color: #e20074;">${stats.satisfactionScore}</div>
        <div style="color: #666; font-size: 0.9em; margin-top: 5px;">Patienten-Zufriedenheit (von 5)</div>
        <div style="font-size: 0.75em; color: #4caf50; margin-top: 5px;">â­â­â­â­â­</div>
      </div>
    </div>
    
    <h4 style="margin: 25px 0 15px 0;">Outcome-Analyse</h4>
    <div style="background: white; padding: 20px; border-radius: 12px;">
      <div style="margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Erfolgreich abgeschlossen</span>
          <span><strong>85%</strong></span>
        </div>
        <div style="background: #f5f5f5; height: 12px; border-radius: 6px;">
          <div style="background: #4caf50; width: 85%; height: 100%; border-radius: 6px;"></div>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Wiederaufnahmen</span>
          <span><strong>8%</strong></span>
        </div>
        <div style="background: #f5f5f5; height: 12px; border-radius: 6px;">
          <div style="background: #f44336; width: 8%; height: 100%; border-radius: 6px;"></div>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Laufende Betreuung</span>
          <span><strong>7%</strong></span>
        </div>
        <div style="background: #f5f5f5; height: 12px; border-radius: 6px;">
          <div style="background: #2196f3; width: 7%; height: 100%; border-radius: 6px;"></div>
        </div>
      </div>
    </div>
    
    <h4 style="margin: 25px 0 15px 0;">ROI-Berechnung</h4>
    <div style="background: white; padding: 20px; border-radius: 12px;">
      <div class="alert-box success">
        <span style="font-size: 1.5em;">ğŸ’°</span>
        <div>
          <strong>Geschaetzter Erloes durch vermiedene Wiederaufnahmen:</strong><br>
          ${stats.preventedReadmissions} x durchschn. 4.500 â‚¬ (DRG) = <strong>18.000 â‚¬</strong> (Monat)<br>
          <em style="font-size: 0.9em;">Refinanzierung des KLIBIZ-Zentrums bereits erreicht!</em>
        </div>
      </div>
    </div>
    
    <h4 style="margin: 25px 0 15px 0;">Audit-Log (letzte Aktivitaeten)</h4>
    <div style="background: white; padding: 15px; border-radius: 12px;">
      <div style="font-size: 0.85em; color: #666; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
        <strong>M. Muehlbach</strong> - Dokumentation erstellt fuer Maria Mueller - ${formatDateTime(new Date())}
      </div>
      <div style="font-size: 0.85em; color: #666; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
        <strong>K. Weber</strong> - Eskalation durchgefuehrt fuer Karl Schmidt - vor 2 Std.
      </div>
      <div style="font-size: 0.85em; color: #666; padding: 8px 0;">
        <strong>M. Muehlbach</strong> - Rueckruf geplant fuer Hans Meier - vor 3 Std.
      </div>
    </div>
  `;
}

function openNoteModal() {
  if (!currentPatient) return;
  document.getElementById('noteText').value = '';
  openModal('noteModal');
}

function submitNote() {
  const text = document.getElementById('noteText').value.trim();
  
  if (!text) {
    alert('Bitte geben Sie eine Notiz ein');
    return;
  }
  
  if (!teamData.notes[currentPatient.id]) {
    teamData.notes[currentPatient.id] = [];
  }
  
  teamData.notes[currentPatient.id].push({
    id: teamData.notes[currentPatient.id].length + 1,
    text: text,
    date: new Date().toISOString(),
    author: 'M. Muehlbach'
  });
  
  alert('Interne Notiz erfolgreich gespeichert!');
  closeModal('noteModal');
}

function openFeedbackModal() {
  if (!currentPatient) return;
  openModal('feedbackModal');
}

function submitFeedback() {
  const rating = parseInt(document.getElementById('feedbackRating').value);
  const comment = document.getElementById('feedbackComment').value;
  const outcome = document.getElementById('feedbackOutcome').value;
  
  teamData.feedbacks[currentPatient.id] = {
    rating: rating,
    comment: comment,
    outcome: outcome,
    date: new Date().toISOString(),
    recordedBy: 'M. Muehlbach'
  };
  
  // Update stats
  if (outcome === 'success') {
    teamData.stats.preventedReadmissions++;
  }
  
  alert(`Feedback erfolgreich erfasst!\n\nBewertung: ${rating}/5 Sterne\nOutcome: ${outcome}`);
  closeModal('feedbackModal');
}

function formatDateTime(date) {
  return new Date(date).toLocaleString('de-DE', {
    day: '2-digit',
    month: '2-digit', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function makePhoneCall() {
  document.getElementById('callTitle').textContent = 'ğŸ“ Telefonanruf';
  document.getElementById('callIcon').textContent = 'ğŸ“';
  document.getElementById('callPatient').textContent = currentPatient.name;
  openModal('callModal');
  
  setTimeout(() => {
    if (currentPatient) {
      currentPatient.messages.push({
        sender: 'system',
        text: 'ğŸ“ Telefonanruf - 12 Minuten',
        time: new Date().toISOString()
      });
      renderMessages();
    }
  }, 3000);
}

function makeVideoCall() {
  document.getElementById('callTitle').textContent = 'ğŸ“¹ Videoanruf';
  document.getElementById('callIcon').textContent = 'ğŸ“¹';
  document.getElementById('callPatient').textContent = currentPatient.name;
  openModal('callModal');
  
  setTimeout(() => {
    if (currentPatient) {
      currentPatient.messages.push({
        sender: 'system',
        text: 'ğŸ“¹ Videoanruf - 15 Minuten',
        time: new Date().toISOString()
      });
      renderMessages();
    }
  }, 3000);
}

function endCall() {
  closeModal('callModal');
}

function openQuickReply() {
  document.getElementById('quickReplyText').value = '';
  openModal('quickReplyModal');
}

function useTemplate(text) {
  document.getElementById('quickReplyText').value = text;
}

function sendQuickReply() {
  const text = document.getElementById('quickReplyText').value.trim();
  if (!text || !currentPatient) return;
  
  currentPatient.messages.push({
    sender: 'nurse',
    text: text,
    time: new Date().toISOString()
  });
  
  closeModal('quickReplyModal');
  renderMessages();
}

function openPegasos() {
  if (!currentPatient) return;
  
  if (currentPatient.id !== 'R2025-001') {
    alert('PEGASOS-Zugriff derzeit nur fuer Maria Mueller verfuegbar.');
    return;
  }
  
  const pegasos = currentPatient.pegasos;
  document.getElementById('pegasosContent').innerHTML = `
    <h4>Patientenakte</h4>
    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
      <strong>Fallnummer:</strong> ${pegasos.fallnummer}<br>
      <strong>Station:</strong> ${pegasos.station}<br>
      <strong>Diagnosen:</strong> ${pegasos.diagnosen.join(', ')}
    </div>
    <p>Vollstaendige PEGASOS-Integration mit Labor, Medikation und Verlauf.</p>
  `;
  
  openModal('pegasosModal');
}

function openDoctorReferral() {
  openModal('doctorModal');
}

function submitDoctorReferral() {
  const urgency = document.getElementById('urgency').value;
  const reason = document.getElementById('doctorReason').value;
  
  if (!reason) {
    alert('Bitte Grund angeben');
    return;
  }
  
  alert('Weiterleitung an Stationsarzt erfolgreich!');
  closeModal('doctorModal');
}

function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function getRiskColor(level) {
  return level === 'high' ? '#f44336' : level === 'medium' ? '#ff9800' : '#4caf50';
}

function formatTime(date) {
  return new Date(date).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
}

function formatRelativeTime(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  if (seconds < 60) return 'Gerade eben';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `vor ${minutes} Min.`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `vor ${hours} Std.`;
  const days = Math.floor(hours / 24);
  return `vor ${days} Tag${days > 1 ? 'en' : ''}`;
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(modal => {
      closeModal(modal.id);
    });
  }
});
</script>

</body>
</html>